# FireFace — Best Practices for Dialogue Systems

> **Источники:** GameAnalytics, GDC Talks, CD Projekt RED, Naughty Dog  
> **Применение:** Magic Awakening: The Aron Heir

---

## 1. Структура диалогового дерева

### Разделяйте выборы и хабы

**Choices (Выборы)** — односторонние решения, меняющие ход истории:
- Игрок выбирает → диалог продолжается → вернуться нельзя
- Используйте для критических моментов
- Чёткие последствия

**Hubs (Хабы информации)** — вопросы для изучения мира:
- Игрок выбирает → получает ответ → возвращается к списку
- Используйте для лора, необязательной информации
- Визуально отличайте от Choices (иконка "?")

**FireFace рекомендация:**
```yaml
# Хаб — можно вернуться
dlg_hub_keira_info:
  type: "hub"
  text: "Что хочешь узнать?"
  choices:
    - text: "Расскажи об Авроре"
      return_to_hub: true
    - text: "Что известно об отце?"
      return_to_hub: true
    - text: "Я готов."
      return_to_hub: false  # Выход из хаба

# Выбор — точка невозврата
dlg_choice_trust_keira:
  type: "choice"
  text: "Доверишься мне?"
  choices:
    - text: "Да" → ветка доверия
    - text: "Нет" → ветка подозрения
```

---

## 2. Не каждый выбор требует глобальных последствий

### Четыре типа влияния выбора

| Тип | Описание | Пример |
|-----|----------|--------|
| **Story** | Меняет сюжет | Персонаж жив/мёртв |
| **Power** | Влияет на геймплей | Получен бонус к мане |
| **Character** | Меняет отношение NPC | NPC злится/симпатизирует |
| **World** | Меняет мир | NPC обсуждают поступок |

**Лучшая практика:** Смешивайте типы. Не все выборы должны менять концовку — локальные изменения тоже ценны.

**FireFace реализация:**
```yaml
choice:
  text: "Я выполню миссию."
  effects:
    - type: "character"
      target: "keira"
      reputation: +10
    - type: "world"
      trigger: "npcs_talk_about_professionalism"
    - type: "story"
      flag: "accepted_mission"
```

---

## 3. Маркируйте критические выборы

**Проблема:** Игрок делает выбор, не понимая масштаба последствий.

**Решения:**
1. **Явное указание:** NPC говорит "Это решит всё. Нет пути назад."
2. **Визуальная маркировка:** Золотая рамка для важных выборов
3. **Автосейв:** Перед критическим выбором

**FireFace предупреждение:**
```cpp
// Перед critical choice
void UDialogueManager::ShowCriticalChoiceWarning()
{
    ShowNotification("Внимание: Этот выбор изменит сюжет");
    AutoSaveGame();
}
```

---

## 4. Дайте важным выборам "время дышать"

**Антипаттерн:** Mass Effect 3 — только финальный выбор определял концовку, делая предыдущие бессмысленными.

**Лучшая практика:** Распределяйте важные выборы по всей игре.

**Пример для The Aron Heir:**
```
Глава 1: Выбор отношения к Кейре → влияет на финал
Глава 2: Решение о доверии магам → влияет на финал  
Глава 3: Поступок с артефактом → определяет концовку
```

**FireFace tracking:**
```yaml
# Сохраняйте выборы для кумулятивного эффекта
dlg_choice_ethics_1:
  tags: ["ethics", "pragmatic"]
  cumulative: "ethics_score"  # +1 к прагматизму

dlg_choice_ethics_2:
  tags: ["ethics", "idealistic"]
  cumulative: "ethics_score"  # -1 от прагматизма

# Финал проверяет накопленный score
```

---

## 5. Ограничивайте ветвление

**Экспоненциальный рост:**
- 3 точки ветвления × 2 опции = 8 концовок
- 3 точки ветвления × 3 опции = 27 концовок

**Рекомендация:** Больше веток → меньше опций на ветку.

**FireFace стратегия:**
```
Мало веток (2-3):  Много опций (4-5) — exploration
Много веток (5+):  Мало опций (2) — focused narrative
```

---

## 6. Используйте варианты вместо полных веток

**Варианты (Variants)** — небольшие изменения в одной и той же сцене.

**Пример:**
- Игрок был груб с Кейрой → она хмурится в следующей сцене
- Игрок помогал → она улыбается
- Диалог тот же, но анимация/тона разные

**FireFace реализация:**
```yaml
scene_meeting_aftermath:
  variants:
    - condition: "keira_attitude > 50"
      animation: "smile"
      voice_tone: "warm"
    - condition: "keira_attitude < -50"
      animation: "frown"
      voice_tone: "cold"
    - default:
      animation: "neutral"
```

---

## 7. Замки и ключи (Locks & Keys)

**Типы замков:**

| Тип | Описание | Пример |
|-----|----------|--------|
| **Open** | Без ограничений | Стандартные диалоги |
| **Direct** | Требует конкретное действие | Наличие предмета |
| **Convergent** | Несколько условий вместе | Убедил 3 генералов |
| **Accumulative** | Накопленное значение | Карма > 75 |

**FireFace синтаксис:**
```yaml
choice:
  text: "[Intelligence 12] Расшифровать руну"
  locks:
    - type: "direct"
      stat: "intelligence"
      value: 12

choice:
  text: "Призвать на помощь армию"
  locks:
    - type: "convergent"
      flags: ["general_1_ally", "general_2_ally", "general_3_ally"]
```

---

## 8. Пишите для обеих сторон разговора

### Опции игрока

**DO:**
- Конкретные фразы: "Скажи мне правду об отце"
- Чёткие намерения: "[Угроза] Ты пожалеешь об этом"

**DON'T:**
- Размытые эмоции: "[Злой] ..."
- Непредсказуемый результат: "Привет" → персонаж плачет

### Показывать или не показывать реплику игрока?

**Вариант A (BioWare):** Показывать полную реплику
```
[Выбор:] "Отпуск закончился три дня назад. Это не дежурство, это выживание."
```

**Вариант B (Bethesda):** Показывать намерение, полный текст после
```
[Выбор:] «Это выживание»
[Тео говорит:] «Отпуск закончился три дня назад. Это не дежурство, это выживание.»
```

**FireFace рекомендация:** Вариант A для драматических сцен, Вариант B для быстрых диалогов.

---

## 9. Естественность разговора

### Избегайте эмоционального диссонанса

**Плохо:** NPC плачет о погибших родителях → игрок спрашивает про квест → NPC весело отвечает.

**Хорошо:** Хабы меняются в зависимости от эмоционального состояния.

**FireFace реализация:**
```yaml
# После трагической сцены
available_topics:
  filter: "mood == 'grieving'"
  hide: ["side_quests", "jokes"]
  show: ["comfort", "silence", "shared_grief"]
```

### Перебивания

**Пример:** Oxenfree — игрок может перебивать NPC.

**FireFace:**
```yaml
dlg_line:
  text: "Ты должен понять, что..."
  interruptible: true
  interrupt_choices:
    - text: "Стоп, я знаю правду!"
      next: "dlg_revelation_shortcut"
    - text: "Продолжай..."
      next: "dlg_explanation_full"
```

---

## 10. Тестирование диалогов

### Что отслеживать

| Метрика | Инструмент | Цель |
|---------|------------|------|
| Выборы | Analytics | Какие опции популярны |
| Пропуски | Heatmaps | Какие диалоги скучны |
| Время | Session recording | Слишком быстро / медленно |

### FireFace debugging

```cpp
// Логирование всех выборов
UFUNCTION()
void LogPlayerChoice(const FString& DialogueId, int32 ChoiceIndex)
{
    UE_LOG(LogFireFace, Log, TEXT("Choice: %s, Option: %d"), 
        *DialogueId, ChoiceIndex);
}
```

---

## 11. Локализация с самого начала

**FText vs FString:**
```cpp
// Правильно
UPROPERTY(EditAnywhere, Category = "Dialogue")
FText DialogText;  // Поддерживает локализацию

// Неправильно
FString DialogText;  // Только для ID/keys
```

**FireFace pipeline:**
1. Тексты в Data Tables
2. Export to CSV
3. Translation
4. Import back
5. Voiceover switching

---

## 12. MetaHuman-специфичные практики

### Face Animation

**DO:**
- Используйте Audio Driven Animation для естественности
- Добавляйте микро-движения (Control Rig)
- Разные presets для разных персонажей

**DON'T:**
- Оставляйте лицо статичным более 3 секунд
- Переусердствуйте с выражениями (uncanny valley)

### Eye Contact

```cpp
// Вариант 1: Смотреть на игрока
LookAtTarget = PlayerCamera;

// Вариант 2: Смотреть в сторону (задумчивость)
LookAtTarget = OffscreenPoint;

// Вариант 3: Избегать взгляда (вина, стыд)
LookAtTarget = None;
```

### Blink Rate
- Норма: 15-20 раз в минуту
- Нервозность: чаще
- Концентрация: реже

---

## 13. Аудио-лучшие практики

### Технические
- Частота дискретизации: **48kHz**
- Формат: **WAV** (мастер) → **Ogg Vorbis** (релиз)
- Нормализация: **-23 LUFS** (dialogue)

### Производственные
- Записывайте все линии одного актёра в одну сессию
- Сохраняйте единый tone
- Используйте reference tracks

### FireFace TTS fallback
- ElevenLabs для качества
- Local Piper для быстрых итераций
- Voice cloning для consistency

---

## Чеклист перед релизом

- [ ] Все диалоги проходятся без застреваний
- [ ] Нет orphaned branches (ветки без выхода)
- [ ] Все локализации проверены
- [ ] Subtitles synced с аудио
- [ ] Gamepad navigation работает
- [ ] Skip функция не ломает flow
- [ ] Save/Load корректно восстанавливает dialogue state

---

*Создано для FireFace Dialogue System*  
*Magic Awakening: The Aron Heir*
